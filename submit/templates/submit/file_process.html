{% extends "submit/base.html" %}

{% block title -%}Process submission files{%- endblock title %}

{% block within_content %}
<h2 class="is-size-4">Process Files</h2>
<form method="POST" action="{{ url_for('ui.file_process', submission_id=submission_id) }}">
  {{ form.csrf_token }}

{% if must_process %}
<div class="columns">
  <div class="column is-one-third-desktop is-one-half-tablet">
    {% if not status %}
    <div class="field is-grouped">
      <div class="control">
        <!-- Selecting a preferred compiler is not supported in v0.1
        <label class="label" id="compiler">Compiler: <span class="icon has-text-link"><i class="fa fa-question-circle"></i></span></label>
        <div class="select">
          {{ form.compiler(**{"aria-labelledby": "compiler"})|safe }}
        </div> -->

        <button class="button is-link" type="submit" value="process" {% if status == "failed" %}disabled=true{% endif %}>Process my submission files</button>
      </div>
    </div>
    {% endif %}

    {% if not status %}
    <div class="message is-info">
      <div class="message-body">
        <p>arXiv's processing system runs TeX Live 2016 and natbib 8.31. Authors are strongly encouraged to upgrade if older versions of these packages are being used to generate files.</p>
      </div>
    </div>

    {% elif status == "in_progress" %}
    <div class="message is-warning">
      <div class="message-header">
        <p><span class="icon"><i class="fa fa-tasks"></i></span>Processing Underway</p></div>
      <div class="message-body">
        <p>We are currently processing your submission. This may take up to a minute or two. Please check back.</p>
      </div>
    </div>

    {% elif status == "failed" %}
    <div class="message is-danger">
      <div class="message-header">
        <p><span class="icon"><i class="fa fa-exclamation-triangle"></i></span>Processing Failed</p></div>
      <div class="message-body">
        <p>What to do next:</p>
        <ul>
          <li>review the log warnings and errors</li>
          <li>correct any missing file problems</li>
          <li>edit your files if needed</li>
          <li>re-upload any corrected files</li>
        </ul>
        <p class="has-text-centered"><a class="button is-link" href="{{ url_for('ui.file_upload', submission_id=submission_id) }}">Go back to Upload Files</a></p>
        <p class="has-text-centered"><a class="button" href="#help">Help: Common TeX Errors</a></p>
      </div>
    </div>

    {% elif status == "success" and warnings %}
    <div class="message is-warning">
      <div class="message-header">
        <p><span class="icon"><i class="fa fa-exclamation-triangle"></i></span>Completed With Warnings</p>
      </div>
      <div class="message-body">
        <ul>
          <li>Be sure to check the compiled preview carefully for any undesired artifacts or errors.</li>
          <li>Check the compiler log for warnings and errors.</l>
        </ul>
      </div>
    </div>

    {% elif status == "success" %}
    <div class="message is-success">
      <div class="message-header">
        <p><span class="icon"><i class="fa fa-check-circle"></i></span>Processing Successful</p></div>
      <div class="message-body">
        <p>Be sure to check the compiled preview carefully for any undesired artifacts or errors.</p>
        <p>If you need to make corrections, return to the previous step and adjust your files, then reprocess your submission.</p>

        <p class="has-text-centered">
          <a class="button is-link" href="{{ url_for('ui.file_preview', submission_id=submission_id) }}" target="_blank">
            View PDF
          </a>
        </p>
      </div>
    </div>
    {% endif %}
    {% for compilation in compilations[::-1] %}
      <li>
        {% if compilation.checksum == submission.source_content.checksum %}Current package{% else %}Previous package{% endif %} started {{ compilation.start_time|timesince }}
        {%- if compilation.status == compilation.Status.SUCCEEDED or compilation.status == compilation.Status.FAILED -%}
          , {{ compilation.status|compilation_status_display }} after {{ (compilation.end_time - compilation.start_time)|duration }}.
        {%- else -%}
          .
        {%- endif %}
      </li>
    {% endfor %}
  </div>

  <div class="column is-two-thirds-desktop is-one-half-tablet">
    {% if not status %}
    <div class="message is-info">
      <div class="message-body">
        <p><span class="icon has-text-link"><i class="fa fa-info-circle"></i></span>
        This step runs all files through a series of automatic checks.<br />
         Additionally, TeX and LaTeX source packages will be compiled into a PDF.</p>

         {{ submission.source_content }}
      </div>
    </div>
    <!-- Selection of preferred compiler is not supported in v0.1
    <div class="message is-info">
      <div class="message-body">
        <p><span class="icon has-text-link"><i class="fa fa-info-circle"></i></span>
        Our system has automatically detected your files as type <strong>filetype</strong>.</p>
        <p> If your submission is not of the type shown above, or if you know which
          <a href="#">TeXLive 2016</a> compiler will process your files best,
          choose that compiler. If you do not know which compiler will process best,
          leave this default alone.</p>
      </div>
    </div> -->
    {% endif %}
    {% if status and log_output %}
    <div class="box texlive-summary">
      <div class="level">
        <div class="level-left">
          <h3>TeXLive Compiler Summary</h3>
        </div>
        <div class="level-right">
          <a class="button" href="{{ url_for('ui.compilation_log', submission_id=submission_id) }}" target="_blank">
            View raw log
          </a>
        </div>
      </div>
      <!-- TODO: don't hard-code this. -->
      <div style="max-height: 50vh; height: 50vh; overflow-y: scroll; color: black; max-width: 100%;">
        <pre><code class="article">{{ log_output }}</code></pre>
      </div>
      <!-- Log parsing is not supported in v0.1
      {% if errors %}
      <article class="has-text-danger">
        <h4 class="has-text-danger">Errors</h4>
        {% for error in errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </article>
      {% endif %}
      {% if warnings %}
      <article class="has-text-warning">
        <h4 class="has-text-warning">Warnings</h4>
        {% for warning in warnings %}
        <p>{{ warning }}</p>
        {% endfor %}
      </article>
      {% endif %}
      {% if messages %}
      <article>
        <h4>Messages with no particular status</h4>
        {% for message in messages %}
        <p>{{ message }}</p>
        <p class="has-text-weight-bold">Perhaps step completion notices in bold</p>
        {% endfor %}
      </article>
      {% endif %} -->
    </div>
    {% endif %}
  </div>
</div>
{% else %}
<div class="box">
  <!-- Liz: this is the language on the legacy interface for PDF-only
       submissions. Not super informative, but... -->
  Source has already been processed.
</div>
{% endif %}

{{ submit_macros.submit_nav(submission_id) }}
</form>
{% endblock within_content %}
